trigger:
  - master
  - tags

stages:
- stage: Render
  displayName: Render
  jobs:
  - job: get_blender
    displayName: Get Blender
    pool:
      vmImage: ubuntu-18.04
    steps:
    - script: |
        wget -O $(Build.ArtifactStagingDirectory)/blender.zip https://ftp.nluug.nl/pub/graphics/blender/release/Blender2.82/blender-2.82-windows64.zip
      displayName: "Download Blender"
    - task: PublishBuildArtifacts@1
      displayName: upload blender to archive.
      inputs:
        artifactName: 'blender'
        pathtoPublish: $(Build.ArtifactStagingDirectory)
  - job: render_on_windows
    displayName: Render on Windows
    dependsOn:
    - get_blender
    pool:
      vmImage: win2019
    workspace:
      clean: all
    strategy:
      parallel: 5
    variables:
      totalFrames: 50
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: download blender
      inputs:
        artifactName: blender
        downloadPath: $(Build.ArtifactStagingDirectory)
    - task: ExtractFiles@1
      inputs:
        archiveFilePatterns: $(Build.ArtifactStagingDirectory)\blender.zip
        destinationFolder: blender
    - script: |
        dir blender
      displayName: Display Folder
  - job: render_on_linux
    displayName: Render on Linux
    pool:
      vmImage: ubuntu-18.04
    workspace:
      clean: all
    strategy:
      parallel: 5 #
    variables:
      totalFrames: 50
    steps:
    - script: |
        sudo apt update
        sudo apt install snapd mesa-utils
      displayName: Install Dependencies
    #- script: |
    #    sudo add-apt-repository ppa:ubuntu-x-swat/updates
    #    sudo ACCEPT_EULA=Y apt-get update
    #    sudo ACCEPT_EULA=Y apt-get dist-upgrade
    #    glxinfo | grep "OpenGL version"
    #  displayName: Install mesa
    - script: |
        sudo snap install blender --classic
    - bash: |
        frames=$(($(totalFrames) / $(System.TotalJobsInPhase)))
        offset=$((($(System.JobPositionInPhase) - 1) * ${frames}))
        if [ $(System.JobPositionInPhase) -eq $(System.TotalJobsInPhase) ]
        then
          frameend=$(((${offset}+$frames)))
        else
          frameend=$(((${offset}+$frames)-1))
        fi
        echo "rendering from ${offset} to ${frameend} total jobs $(System.TotalJobsInPhase) job id $(System.JobPositionInPhase)"
        echo "blender -b test.blend -noaudio -E CYCLES -x 1 -F PNG -o $(Build.ArtifactStagingDirectory)/frame_#### -s ${offset} -e ${frameend} -a"
        blender -b test.blend -noaudio -E CYCLES -x 1 -F PNG -o $(Build.ArtifactStagingDirectory)/frame_#### -s ${offset} -e ${frameend} -a 
      displayName: Render
    - script: |
        find $(Build.ArtifactStagingDirectory)
      displayName: Results
    - task: PublishBuildArtifacts@1
      displayName: upload render output
      inputs:
        artifactName: 'render'
        pathtoPublish: $(Build.ArtifactStagingDirectory)
  - job: generate_movie
    displayName: Generate Movie
    dependsOn:
    - render_on_linux
    steps:
    - task: DownloadBuildArtifacts@0
      displayName: download render output
      inputs:
        artifactName: render
        downloadPath: $(Build.ArtifactStagingDirectory)
